<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
  
  <!-- Define the product -->
  <Product Id="*" 
           Name="Animus CLI" 
           Language="1033" 
           Version="1.0.0.0" 
           Manufacturer="Animus" 
           UpgradeCode="PUT-GUID-HERE">
    
    <Package InstallerVersion="200" Compressed="yes" />
    <MediaTemplate EmbedCab="yes" />
    
    <!-- Define the directory structure -->
    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="Animus">
          <!-- Main application files -->
          <Directory Id="ANIMUSMAIN" Name=".">
            <Component Id="MainExecutables" Guid="*">
              <File Id="AnimusBat" Source="animus.bat" KeyPath="yes" />
              <File Id="RunAnimusBat" Source="run_animus.bat" />
              <File Id="AnimusCliPy" Source="animus_cli.py" />
              <File Id="RequirementsTxt" Source="requirements.txt" />
              <RegistryValue Root="HKLM" Key="Software\Animus" Name="InstallPath" Value="[INSTALLFOLDER]" Type="string" />
            </Component>
          </Directory>
          
          <!-- Animus CLI module -->
          <Directory Id="ANIMUSCLI" Name="animus_cli">
            <Component Id="AnimusCliModule" Guid="*">
              <File Id="AnimusCliInit" Source="animus_cli\__init__.py" KeyPath="yes" />
              <File Id="AnimusCliMain" Source="animus_cli\main.py" />
              <File Id="AnimusCliLlmManager" Source="animus_cli\llm_manager.py" />
              <File Id="AnimusCliLogProcessor" Source="animus_cli\log_processor.py" />
            </Component>
          </Directory>
          
          <!-- PowerShell scripts -->
          <Directory Id="POWERSHELL" Name="powershell">
            <Component Id="PowerShellScripts" Guid="*">
              <File Id="CollectLogsPs1" Source="powershell\collect_logs.ps1" KeyPath="yes" />
            </Component>
          </Directory>
          
          <!-- Logs directory -->
          <Directory Id="LOGS" Name="logs">
            <Component Id="LogsDirectory" Guid="*">
              <CreateFolder />
            </Component>
          </Directory>
        </Directory>
      </Directory>
      
      <!-- Start Menu shortcuts -->
      <Directory Id="ProgramMenuFolder">
        <Directory Id="AnimusProgramMenu" Name="Animus">
          <Component Id="ProgramMenuShortcuts" Guid="*">
            <Shortcut Id="AnimusShortcut" 
                      Name="Animus CLI" 
                      Description="Windows Event Log Analysis Tool" 
                      Target="[#AnimusBat]" 
                      WorkingDirectory="INSTALLFOLDER" />
            <RemoveFolder Id="AnimusProgramMenuDir" On="uninstall" />
            <RegistryValue Root="HKCU" Key="Software\Animus" Name="installed" Type="integer" Value="1" />
          </Component>
        </Directory>
      </Directory>
    </Directory>
    
    <!-- Define the features -->
    <Feature Id="AnimusFeature" Title="Animus CLI" Level="1">
      <ComponentRef Id="MainExecutables" />
      <ComponentRef Id="AnimusCliModule" />
      <ComponentRef Id="PowerShellScripts" />
      <ComponentRef Id="LogsDirectory" />
      <ComponentRef Id="ProgramMenuShortcuts" />
    </Feature>
    
    <!-- UI for the installer -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <UIRef Id="WixUI_InstallDir" />
    
    <!-- Custom actions for PATH modification -->
    <CustomAction Id="AddToPath" 
                  Directory="INSTALLFOLDER" 
                  Execute="deferred" 
                  Return="check" 
                  Impersonate="no"
                  ExeCommand="[SystemFolder]cmd.exe /c setx PATH &quot;%PATH%;[INSTALLFOLDER]&quot; /M" />
    
    <CustomAction Id="RemoveFromPath" 
                  Directory="INSTALLFOLDER" 
                  Execute="deferred" 
                  Return="check" 
                  Impersonate="no"
                  ExeCommand="[SystemFolder]cmd.exe /c setx PATH &quot;%PATH:[INSTALLFOLDER];%&quot; /M" />
    
    <!-- Install Python dependencies -->
    <CustomAction Id="InstallDependencies" 
                  Directory="INSTALLFOLDER" 
                  Execute="deferred" 
                  Return="check" 
                  Impersonate="no"
                  ExeCommand="[SystemFolder]cmd.exe /c python -m pip install -r requirements.txt" />
    
    <!-- Install sequence -->
    <InstallExecuteSequence>
      <Custom Action="AddToPath" After="InstallFiles">NOT Installed</Custom>
      <Custom Action="RemoveFromPath" Before="RemoveFiles">REMOVE="ALL"</Custom>
      <Custom Action="InstallDependencies" After="InstallFiles">NOT Installed</Custom>
    </InstallExecuteSequence>
    
    <!-- Silent installation properties -->
    <Property Id="MSIRESTARTMANAGERCONTROL" Value="Disable" />
    <Property Id="ALLUSERS" Value="1" />
    
  </Product>
</Wix> 